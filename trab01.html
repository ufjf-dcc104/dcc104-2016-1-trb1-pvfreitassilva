<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<title>Trab01</title>
		<style>
			canvas {
				border: 1px solid black;
			}
			body{
				width: 1000px;
				margin: auto;
			}
		</style>
	</head>
	<body>
	<h1>Trab01</h1>
	<canvas width="800" height="500">
		Seu navegador n√£o tem suporte ao canvas!
		Atualize seu navegador.
	</canvas>

	<script>
		var tela = document.getElementsByTagName("canvas")[0];
		var ctx = tela.getContext("2d");
		var fps = 50;
		var dt = 1/fps;

		var chao_gelo = new Image();
		chao_gelo.src = "img/ice-floor.png"; //http://opengameart.org/content/hand-painted-texture-floor-tile
		var chao_neve = new Image();
		chao_neve.src = "img/snow.jpg"; //http://opengameart.org/content/tomeks-seamless-snow-textures
		var imgTiros = new Image();
		imgTiros.src = "img/tiros.png";
		var boneco = new Image();
		boneco.src = "img/boneco-neve.png"; //http://opengameart.org/content/32x32-snowman-for-isometric-tile-set
		var personagem = new Image();
		personagem.src = "img/personagem.png";

		var cenario = new Cenario();
		var pc = new Sprite();
		var inimigos = [];
		var excluir = [];
		var tiro = new Sprite();

		tiro.y =  -12000;
		tiro.raio = 6;
		tiro.cor = 'yellow';
		tiro.col = 0;
		tiro.restricoes = function () {};
		tiro.desenhar=function(){
			//img, sx, sy, sw, sh, dx, dy, dw, dh
			ctx.drawImage(imgTiros, Math.floor(this.col)*32, 0, 32, 32,
					this.x-this.raio, this.y-this.raio, 2*this.raio, 2*this.raio);
			
			if(this.col >= 4)
				this.col = 0;
			else
				this.col += 5*dt;

		};

		function Cenario(){
			this.mapa=[	[0,0,0,1,0,0,0,0,0,0],
						[0,0,0,0,0,1,0,0,0,0],
						[0,0,0,0,0,0,0,0,0,0],
						[0,0,0,0,0,0,0,1,0,0],
						[0,0,0,1,0,0,0,0,0,0],
						[0,0,0,1,0,0,1,1,1,0],
						[0,0,0,0,0,0,1,1,1,0],
						[0,0,0,0,0,1,0,0,0,0],
						[0,0,0,0,0,0,0,1,0,0],
						[0,0,0,0,0,0,0,0,0,0]];
		} 

		Cenario.prototype.desenhar = function(){
			var i,j;
			for(i=0;i<10;i++)
				for(j=0;j<10;j++){
					if(this.mapa[i][j]==0)
						ctx.drawImage(chao_gelo, i*64, j*64);
					else
						ctx.drawImage(chao_neve, i*64, j*64);
			}
		}

		function criaInimigo(x, y){
			var inimigo = new Sprite();
			inimigo.x = x;
			inimigo.y = y;
			//inimigo.ay = 10;
			inimigo.raio=15;
			inimigo.col = 0;
			inimigo.restricoes = function () {
				if(this.y>tela.height+15){
					this.x = pc.x+50-Math.random()*100;
					this.y = -30-Math.random()*150;
					this.vy = 50-Math.random()*20;
					this.vx = 50;
				}
				this.ax = 0.8*(pc.x-this.x);
			};
			inimigo.desenhar = function(){
				//ctx.drawImage(boneco,	this.x-this.raio,
				//							this.y-this.raio,
				//							2*this.raio,
				//							2*this.raio);


				ctx.drawImage(boneco, Math.floor(this.col)*32, 0, 32, 32,
					this.x-this.raio, this.y-this.raio, 2*this.raio, 2*this.raio);
			
				if(this.col >= 2)
					this.col = 0;
				else
					this.col += 1*dt;


			};
			inimigo.move = function(){
				this.vx = this.vx + this.ax*dt
				if(this.vx > 50)
					this.vx=100;
	 			this.x = this.x + this.vx*dt;
	 			this.vy = this.vy + this.ay*dt;
	 			this.y = this.y + this.vy*dt;
			}
			return inimigo;
		}
		for (var i = 0; i < 10; i++) {
			inimigos.push(criaInimigo(100+20*i, -40*i));
		}

		function Sprite(){
	 		this.x = 110;
	 		this.y = 115;
			this.raio = 16;
	 		this.vx = 0;
	 		this.ax = 0;
	 		this.vy = 0;
	 		this.ay = 0;
 		}

 		pc.desenhar = function (){
 			ctx.drawImage(personagem, this.x - personagem.width/2, this.y - personagem.height/2);
 		}

 		Sprite.prototype.mover = function (){
 			this.vx = this.vx + this.ax*dt - 0.2*this.vx;
 			this.x = this.x + this.vx*dt;
 			this.vy = this.vy + this.ay*dt- 0.2*this.vy;
 			this.y = this.y + this.vy*dt;
 		}

 		Sprite.prototype.colidiu = function (alvo) {
			var distancia = Math.sqrt(
						Math.pow(alvo.x - this.x, 2)+
						Math.pow(alvo.y - this.y, 2)
			);
			return distancia<(alvo.raio+this.raio);
		}

		Sprite.prototype.restricoes = function(){
			if(this.x<15){
				this.x = 15;
				this.vx = 0;
				this.ax = 0;
			}
			if(this.x>tela.width-15) {
				this.x=tela.width-15;
				this.vx = 0;
				this.ax = 0;
			}
			if(this.y<15){
				this.y = 15;
				this.vy = 0;
				this.ay = 0;
			}
			if(this.y>tela.height-15) {
				this.y=tela.height-15;
				this.vy = 0;
				this.ay = 0;
			}

			if( cenario.mapa[Math.floor(this.x/64)][Math.floor(this.y/64)]==1){
				this.vx = 0;
				this.ax=0;
				this.ay=0;
			}
		}

		function passo(){
			pc.mover();
			for (var i in inimigos) {
				inimigos[i].mover();
			}
			tiro.mover();
			pc.restricoes();
			for (var i in inimigos) {
				inimigos[i].restricoes();
			}
			tiro.restricoes();

 			ctx.clearRect(0,0, tela.width, tela.height);

			cenario.desenhar();

			for (var i in inimigos) {
				inimigos[i].desenhar();
			}

			pc.desenhar();

			tiro.desenhar();

			for (var i in inimigos) {
				//if(pc.danificado<=0 && pc.colidiu(inimigos[i])){
					//pc.danificado = 2;
				//	inimigos[i].y = 1200;
				//}
				if(tiro.colidiu(inimigos[i])){
					inimigos[i].y = 1200;
					//excluir.push(inimigos[i]);
					tiro.y = -1200;
				}
			}
			
		}

		function teclaPressionada(e){
			switch(e.keyCode){
				case 32:
					if(tiro.y < -10){
						tiro.x = pc.x;
						tiro.y = pc.y;
						tiro.vy = -200;
					}
				break;
				case 37:
					pc.ax = -300;
				break;
				case 39:
					pc.ax = 300;
				break;
				case 38:
					pc.ay = -300;
				break;
				case 40:
					pc.ay = 300;
				break;
			}
		}

		function teclaSolta(e){
				switch(e.keyCode){
				case 37:
				case 39:
					pc.ax = 0;
					break;
				case 38:
				case 40:
					pc.ay = 0;
				break;
			}
		}

		setInterval(passo, 1000/fps);
		addEventListener("keydown", teclaPressionada);
		addEventListener("keyup", teclaSolta);

	</script>
	</body>
</html>